<div class="admin-layout">
  <!-- Mobile top bar -->
  <div class="mobile-topbar">
    <button class="hamburger-btn" (click)="toggleSidebar()">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
    <h2>Admin Panel</h2>
  </div>

  <!-- Sidebar -->
  <aside class="admin-sidebar" [class.open]="sidebarOpen">
    <div class="sidebar-header">
      <h2>Admin Panel</h2>
      <p class="admin-email">{{ currentUser?.email }}</p>
    </div>
    <nav class="sidebar-nav">
      <button [class.active]="activeTab === 'website'" (click)="setActiveTab('website')">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
        </svg>
        Edit Website
      </button>
      <button [class.active]="activeTab === 'products'" (click)="setActiveTab('products')">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
          <line x1="3" y1="6" x2="21" y2="6"></line>
          <path d="M16 10a4 4 0 0 1-8 0"></path>
        </svg>
        Products
      </button>
      <button [class.active]="activeTab === 'users'" (click)="setActiveTab('users')">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        Users
      </button>
    </nav>
    <button class="logout-btn" (click)="logout()">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
        <polyline points="16 17 21 12 16 7"></polyline>
        <line x1="21" y1="12" x2="9" y2="12"></line>
      </svg>
      Logout
    </button>
  </aside>

  <!-- Overlay for mobile sidebar -->
  @if (sidebarOpen) {
    <div class="sidebar-overlay" (click)="toggleSidebar()"></div>
  }

  <!-- Content Area -->
  <main class="admin-content">

    <!-- Tab 1: Edit Website -->
    @if (activeTab === 'website') {
      <section class="tab-content">
        <h1>Edit Website</h1>

        @if (shopSaveMessage) {
          <div class="success-banner">{{ shopSaveMessage }}</div>
        }
        @if (shopSaveError) {
          <div class="error-banner">{{ shopSaveError }}</div>
        }

        @if (shopLoading && !shop) {
          <div class="loading">Loading shop data...</div>
        } @else if (shop) {
          <div class="form-card">
            <h3>Hero Section</h3>
            <div class="form-group">
              <label>Title (Shop Name)</label>
              <input type="text" [(ngModel)]="shopForm.name" placeholder="e.g. Modern Furniture" />
            </div>
            <div class="form-group">
              <label>Subtitle / Slogan</label>
              <input type="text" [(ngModel)]="shopForm.slogan" placeholder="e.g. Quality, style, comfort" />
            </div>
            <div class="form-group">
              <label>Button Text</label>
              <input type="text" [(ngModel)]="shopForm.buttonText" placeholder="e.g. Shop Now" />
            </div>
            <div class="form-group">
              <label>Hero Image URL</label>
              <input type="text" [(ngModel)]="shopForm.heroImage" placeholder="https://..." />
            </div>

            <h3>Branding</h3>
            <div class="form-group">
              <label>Logo (URL or text)</label>
              <input type="text" [(ngModel)]="shopForm.logo" placeholder="Logo URL or brand name" />
            </div>

            <button class="save-btn" (click)="saveShop()" [disabled]="shopLoading">
              {{ shopLoading ? 'Saving...' : 'Save Changes' }}
            </button>
          </div>
        }
      </section>
    }

    <!-- Tab 2: Products -->
    @if (activeTab === 'products') {
      <section class="tab-content">
        <div class="tab-header">
          <h1>Products</h1>
          <button class="btn-add" disabled title="Coming soon">
            <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add New Product
          </button>
        </div>

        @if (productSaveMessage) {
          <div class="success-banner">{{ productSaveMessage }}</div>
        }
        @if (productSaveError) {
          <div class="error-banner">{{ productSaveError }}</div>
        }

        @if (productsLoading) {
          <div class="loading">Loading products...</div>
        } @else if (products.length === 0) {
          <div class="empty-state">No products found for this shop.</div>
        } @else {
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Price</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (product of products; track product._id) {
                  <tr>
                    <td>
                      <img [src]="product.image" class="product-thumb" alt="{{ product.name }}" />
                    </td>
                    @if (editingProductId === product._id) {
                      <td><input type="text" [(ngModel)]="productEditForm.name" class="table-input" /></td>
                      <td><input type="text" [(ngModel)]="productEditForm.description" class="table-input" /></td>
                      <td><input type="number" [(ngModel)]="productEditForm.price" step="0.01" class="table-input table-input-price" /></td>
                      <td class="actions">
                        <div class="actions-inner">
                          <button class="btn-save" (click)="saveProduct(product)">Save</button>
                          <button class="btn-cancel" (click)="cancelEditProduct()">Cancel</button>
                        </div>
                      </td>
                    } @else {
                      <td>{{ product.name }}</td>
                      <td class="desc-cell">{{ product.description || '—' }}</td>
                      <td>{{ product.price | currency:(shop?.currency || 'USD') }}</td>
                      <td class="actions">
                        <div class="actions-inner">
                          <button class="btn-edit" (click)="startEditProduct(product)">Edit</button>
                          <button class="btn-delete" disabled title="Coming soon">Delete</button>
                        </div>
                      </td>
                    }
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </section>
    }

    <!-- Tab 3: Users -->
    @if (activeTab === 'users') {
      <section class="tab-content">
        <h1>Users</h1>

        @if (userDeleteMessage) {
          <div class="success-banner">{{ userDeleteMessage }}</div>
        }
        @if (userDeleteError) {
          <div class="error-banner">{{ userDeleteError }}</div>
        }
        @if (userRoleMessage) {
          <div class="success-banner">{{ userRoleMessage }}</div>
        }
        @if (userRoleError) {
          <div class="error-banner">{{ userRoleError }}</div>
        }

        @if (usersLoading) {
          <div class="loading">Loading users...</div>
        } @else if (users.length === 0) {
          <div class="empty-state">No users found for this shop.</div>
        } @else {
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Registered</th>
                  <th>Role</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (user of users; track user._id) {
                  <tr>
                    <td>{{ user.fullName }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.createdAt ? (user.createdAt | date:'mediumDate') : '—' }}</td>
                    <td>
                      @if (user._id === currentUser?._id) {
                        <span class="role-badge" [class.admin]="user.role.toLowerCase() === 'admin'">
                          {{ user.role }}
                        </span>
                      } @else {
                        <select
                          class="role-select"
                          [value]="user.role"
                          [disabled]="updatingRoleUserId === user._id"
                          (change)="changeUserRole(user, $any($event.target).value)">
                          <option value="customer">customer</option>
                          <option value="admin">admin</option>
                        </select>
                      }
                    </td>
                    <td class="actions">
                      <div class="actions-inner">
                        @if (canDeleteUser(user)) {
                          <button class="btn-delete" (click)="deleteUser(user)">Delete</button>
                        } @else {
                          <span class="protected-label">
                            {{ user._id === currentUser?._id ? '(You)' : 'Admin' }}
                          </span>
                        }
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </section>
    }
  </main>
</div>
